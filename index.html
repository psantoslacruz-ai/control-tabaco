<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Control de Tabaco</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{ --bg:#0b1020; --fg:#f8fafc; --muted:#94a3b8; --card:rgba(255,255,255,0.06); --card-border:rgba(255,255,255,0.12); --input-bg:#0f172a; --input-border:#334155; --accent:#facc15; --axis:#f8fafc; }
    .theme-light{ --bg:#ffffff; --fg:#0f172a; --muted:#334155; --card:#f1f5f9; --card-border:#e2e8f0; --input-bg:#ffffff; --input-border:#cbd5e1; --accent:#0ea5e9; --axis:#0f172a; }
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg)}
    .card{background:var(--card);border-radius:1rem;padding:1rem;border:1px solid var(--card-border)}
    .btn{transition:transform .05s ease}
    .btn:active{transform:scale(.98)}
    .highlight{font-size:2.75rem;font-weight:800;color:var(--accent)}
    .label{font-size:0.85rem;color:var(--muted)}
    .num{font-variant-numeric:tabular-nums}
    .input{background:var(--input-bg);border:1px solid var(--input-border);color:var(--fg)}
  </style>
</head>
<body class="min-h-full">
  <div class="max-w-4xl mx-auto px-4 py-6 space-y-6">
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <h1 class="text-3xl font-extrabold tracking-tight">Control de Tabaco</h1>
      <div class="flex gap-2">
        <button id="toggleTheme" class="btn rounded-xl px-4 py-2 bg-slate-700 text-white">Modo claro/oscuro</button>
        <button id="exportBtn" class="btn rounded-xl px-4 py-2 bg-slate-700 text-white">Exportar CSV</button>
      </div>
    </header>

    <!-- Stats -->
    <section class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="card text-center"><p class="label">Hoy</p><p id="todayCount" class="highlight num">0</p><p id="sinceLast" class="text-xs" style="color:var(--muted)">—</p></div>
      <div class="card text-center"><p class="label">Objetivo</p><p id="goalText" class="highlight num">—</p><p class="text-sm" style="color:var(--muted)">Restan <span id="remaining">—</span></p><div class="w-full bg-slate-700/60 rounded-full h-2 mt-2"><div id="goalBar" class="h-2 rounded-full bg-emerald-500" style="width:0%"></div></div></div>
      <div class="card text-center"><p class="label">Coste mes</p><p id="costMonth" class="highlight num">€0</p></div>
      <div class="card text-center"><p class="label">Racha</p><p id="streak" class="highlight num">0h</p></div>
    </section>

    <!-- Achievements -->
    <section class="card">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold">Logros / Insignias</h2>
        <small class="label">Se otorgan al cerrar día</small>
      </div>
      <div id="badges" class="flex flex-wrap gap-2"></div>
    </section>

    <!-- Actions -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="card flex flex-col gap-4">
        <h2 class="text-lg font-semibold">Registrar</h2>
        <div class="grid grid-cols-2 gap-3">
          <button id="smokeBtn" class="btn rounded-xl px-4 py-3 bg-red-500 text-black font-semibold">🚬 Fumé</button>
          <button id="cravingBtn" class="btn rounded-xl px-4 py-3 bg-emerald-400 text-black font-semibold">💪 Resistido</button>
        </div>
        <textarea id="note" class="mt-2 w-full rounded-xl input p-3 text-sm" rows="2" placeholder="Nota opcional"></textarea>
      </div>

      <div class="card flex flex-col gap-3">
        <h2 class="text-lg font-semibold">Ajustes</h2>
        <label class="label">Objetivo<input id="goalInput" type="number" class="mt-1 w-full rounded-xl input p-2"/></label>
        <div class="grid grid-cols-2 gap-3">
          <label class="label">Precio €<input id="packPrice" type="number" step="0.01" class="mt-1 w-full rounded-xl input p-2"/></label>
          <label class="label">Cigs/paquete<input id="cigsPerPack" type="number" class="mt-1 w-full rounded-xl input p-2"/></label>
        </div>
        <label class="label">Límite pausa<input id="urgeWindow" type="number" class="mt-1 w-full rounded-xl input p-2"/></label>
        <button id="saveSettings" class="btn mt-2 rounded-xl px-4 py-2 bg-slate-700 text-white">Guardar ajustes</button>
      </div>

      <div class="card flex flex-col gap-4">
        <h2 class="text-lg font-semibold">Fin de día</h2>
        <p class="text-sm" style="color:var(--muted)">Pulsa al acabar la jornada para ver resumen y logros.</p>
        <button id="closeDay" class="btn rounded-xl px-4 py-3 bg-blue-500 text-black font-semibold">📅 Cerrar día</button>
      </div>
    </section>

    <!-- Charts -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="card"><h3 class="font-semibold mb-2">Últimos 7 días</h3><canvas id="weekChart" height="140"></canvas></div>
      <div class="card"><h3 class="font-semibold mb-2">Este mes</h3><canvas id="monthChart" height="140"></canvas></div>
    </section>

    <!-- Log -->
    <section class="card">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Historial</h2>
        <div class="flex items-center gap-2 text-sm">
          <label class="label">Filtrar<input id="filterDate" type="date" class="ml-2 rounded-lg input p-2" /></label>
          <button id="clearFilter" class="btn rounded-lg px-3 py-2 bg-slate-700 text-white">Quitar filtro</button>
        </div>
      </div>
      <div id="log" class="space-y-2 max-h-80 overflow-auto pr-2"></div>
      <button id="clearAll" class="mt-4 btn rounded-xl px-4 py-2 bg-red-600 text-white font-semibold">Borrar todo</button>
    </section>

    <footer class="text-center text-xs" style="color:var(--muted)">Datos guardados localmente en tu dispositivo.</footer>
  </div>

<script>
// ====== Utilidades ======
const fmtDate=(d=new Date())=>d.toISOString().slice(0,10);
const prettyTime=ts=>new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
const since=ts=>{ if(!ts) return '—'; const ms=Date.now()-ts; const m=Math.floor(ms/60000); const h=Math.floor(m/60); return h>0?`${h}h ${m%60}m`:`${m}m`; };
function $(id){ return document.getElementById(id); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

// ====== Estado ======
const STORAGE_KEY='smoke-tracker-v1';
const defaultState={ entries:[], achievements:[], closedDays:{}, settings:{ theme:'dark', goal:10, packPrice:6, cigsPerPack:20, urgeWindow:10 } };
let state=load();
function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || structuredClone(defaultState);} catch{ return structuredClone(defaultState);} }
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

// ====== Inicio ======
applyTheme();
bindEvents();
render();

function applyTheme(){ document.body.classList.toggle('theme-light', state.settings.theme==='light'); }

function bindEvents(){
  const addEv=(id,handler)=>{ const el=$(id); if(el){ el.addEventListener('click',handler); el.addEventListener('touchend',handler); }};
  addEv('smokeBtn', ()=>addEntry('smoke'));
  addEv('cravingBtn', ()=>addEntry('urge'));
  addEv('saveSettings', saveSettings);
  addEv('clearAll', clearAll);
  addEv('exportBtn', exportCSV);
  $('filterDate')?.addEventListener('change', renderLog);
  addEv('clearFilter', ()=>{ const fd=$('filterDate'); if(fd){ fd.value=''; renderLog(); }});
  addEv('toggleTheme', ()=>{ state.settings.theme = (state.settings.theme==='dark'?'light':'dark'); save(); applyTheme(); render(); });
  addEv('closeDay', ()=>{ const res=closeDay(); if(res) showSummaryModal(res); });
}

// ====== Datos ======
function addEntry(type){ state.entries.push({ts:Date.now(), type, note:($('note')?.value||'').trim()||undefined}); if($('note')) $('note').value=''; save(); render(); }
function getTodayEntries(){ const today=fmtDate(); return state.entries.filter(e=>fmtDate(new Date(e.ts))===today); }
function lastSmokeTs(){ const last=[...state.entries].reverse().find(e=>e.type==='smoke'); return last? last.ts : undefined; }
function monthStats(){ const n=new Date(); const y=n.getFullYear(), m=n.getMonth(); const f=new Date(y,m,1).getTime(); const nx=new Date(y,m+1,1).getTime(); const arr=state.entries.filter(e=>e.type==='smoke' && e.ts>=f && e.ts<nx); return { total:arr.length, cost: arr.length*(state.settings.packPrice/state.settings.cigsPerPack) }; }

// ====== Ajustes ======
function saveSettings(){
  const goal=parseInt($('goalInput').value,10);
  const packPrice=parseFloat($('packPrice').value);
  const cigsPerPack=parseInt($('cigsPerPack').value,10);
  const urgeWindow=parseInt($('urgeWindow').value,10);
  if(!isNaN(goal)) state.settings.goal=goal;
  if(!isNaN(packPrice)) state.settings.packPrice=packPrice;
  if(!isNaN(cigsPerPack)) state.settings.cigsPerPack=cigsPerPack;
  if(!isNaN(urgeWindow)) state.settings.urgeWindow=urgeWindow;
  save();
  render();
  alert('Ajustes guardados');
}

// ====== Logros ======
const BADGES={ hour1:{id:'hour1',label:'🕐 1h sin fumar'}, belowGoalToday:{id:'belowGoalToday',label:'🎯 Primer día por debajo del objetivo'} };
function checkAchievements(){ const have=new Set(state.achievements); const last=lastSmokeTs(); if(last && (Date.now()-last)>=60*60000 && !have.has('hour1')){ state.achievements.push('hour1'); } }
function renderBadges(){ const c=$('badges'); if(!c) return; c.innerHTML=''; const have=new Set(state.achievements); const list=Object.values(BADGES).filter(b=>have.has(b.id)); if(list.length===0){ c.innerHTML='<span class="text-sm" style="color:var(--muted)">Sin logros aún.</span>'; return; } list.forEach(b=>{ const tag=document.createElement('span'); tag.className='inline-flex items-center gap-2 text-sm px-3 py-1 rounded-full'; tag.style.background='var(--card)'; tag.style.border='1px solid var(--card-border)'; tag.textContent=b.label; c.appendChild(tag); }); }

// ====== Render ======
let weekChart, monthChart;
function render(){
  checkAchievements();
  const todaySmokes=getTodayEntries().filter(e=>e.type==='smoke').length;
  $('todayCount').textContent=todaySmokes;
  const last=lastSmokeTs();
  $('sinceLast').textContent= last?`Último: ${prettyTime(last)} (${since(last)})`:'Sin registros';
  $('streak').textContent=since(last);
  $('goalText').textContent=state.settings.goal;
  $('remaining').textContent=Math.max(0,state.settings.goal-todaySmokes);
  const pct=state.settings.goal?Math.min(100,Math.round((todaySmokes/state.settings.goal)*100)):0;
  $('goalBar').style.width=`${pct}%`; $('goalBar').className=`h-2 rounded-full ${pct<70?'bg-emerald-500':pct<100?'bg-yellow-400':'bg-red-500'}`;
  const ms=monthStats(); $('costMonth').textContent=`€${ms.cost.toFixed(2)}`;
  $('goalInput').value=state.settings.goal; $('packPrice').value=state.settings.packPrice; $('cigsPerPack').value=state.settings.cigsPerPack; $('urgeWindow').value=state.settings.urgeWindow;
  renderCharts(); renderLog(); renderBadges(); save();
}

// ... resto del código (charts, log, etc.)
</script>
</body>
</html>

